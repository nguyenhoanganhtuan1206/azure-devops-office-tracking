jobs:
  - job: Build
    pool:
      vmImage: "ubuntu-latest"
    variables:
      jdkVersion: 17
    steps:
      - task: JavaToolInstaller@0
        displayName: Install jdk ver $(jdkVersion)
        inputs:
          versionSpec: $(jdkVersion)
          jdkSourceOption: PreInstalled
          jdkArchitectureOption: "x64"

      - script: |
          sudo apt-get update
          sudo apt-get install dos2unix
          dos2unix gradlew
        displayName: Convert the line endings to Unix format

      - script: chmod +x gradlew
        displayName: Grant permission for gradlew

      - script: ./gradlew clean build
        displayName: Clean and build new artifact

      - task: PublishBuildArtifacts@1
        displayName: Publish build artifact
        inputs:
          PathtoPublish: "$(Build.SourcesDirectory)"
          ArtifactName: "drop"
          publishLocation: "Container"

  - job: Build_Push_Image
    displayName: "Build an Push an image to Container Registry"
    dependsOn: Build
    condition: succeeded()

    variables:
      imageRepository: "officetrackingimage"
      containerRegistry: "officetrackingcr.azurecr.io"

    steps:
      - task: Docker@2
        displayName: "Build and Push"
        inputs:
          command: buildAndPush
          repository: "officetrackingdocker"
          containerRegistry: myDRServiceConnection
          Dockerfile: "**/Dockerfile"
          tags: 'latest'